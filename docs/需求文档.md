# symbolPop

## 1. 背景与目标

### 1.1 背景

用户经常需要在任意应用（Word、浏览器、IDE、聊天软件等）快速输入 **Unicode 符号**（尤其是希腊字母、数学符号），希望体验类似 Windows `Win + .` 的面板：**全局快捷键唤起 → 输入关键词 → 回车直接输出到当前光标位置**。

### 1.2 目标（Goals）

* 提供一个 **轻量、常驻托盘、默认隐藏** 的符号输入工具。
* 支持 **全局快捷键唤起输入框**（默认 `Alt + S`），可配置。
* 输入关键词（key，例如 `sigma`）后，实时搜索过滤（type-to-filter）。
* 回车后将匹配的符号 **输出到当前光标处**。
* 提供管理页：用户可创建/修改/删除自己的 key-value 映射（支持多语言 key、LaTeX 风格 key 等）。
* 系统内置映射（默认字典）**不可被修改**，但可被用户映射“覆盖优先级”（见后文策略）。

### 1.3 非目标（Non-goals）

* 不做完整 LaTeX 解析器（仅支持“映射式”的 `\sigma -> σ`、`sum -> Σ` 等）。
* 不做云同步（本版本仅本地 IndexedDB）。
* 不做复杂文本编辑器插件（只做系统级输入）。

---

## 2. 运行环境与技术约束

### 2.1 UI 技术

* **必须使用 Fluent UI**（Fluent UI React）以对齐原生 Windows 视觉风格。
* 应用形态建议：**Tauri + Web 前端（Fluent UI）**

  * UI：Fluent UI（React）
  * Core：Rust（Tauri）
  * 数据：IndexedDB（前端侧）

> 注：Fluent UI 主要面向 Web/React，因此“用 Fluent UI 对齐 Windows UI”更适合 Tauri/WinUI 风格的 WebView 应用路线。

### 2.2 数据存储

* 必须使用 **IndexedDB** 存储 key-value 映射与用户设置。
* 数据模型需支持：

  * 系统内置映射（只读、随版本更新）
  * 用户自定义映射（可写）
  * 优先级合并与冲突策略

---

## 3. 核心交互（用户体验）

### 3.1 常态

* 应用启动后 **默认最小化到托盘**，不显示主窗口。
* 托盘菜单提供：

  * 打开（或显示）管理页面
  * 快速输入（等价于快捷键唤起）
  * 设置
  * 退出

### 3.2 唤起与输入

* 默认全局快捷键：`Alt + S`
* 触发后弹出一个小型“浮层/面板”（类似 PowerToys Run / Emoji 面板的轻量窗口）：

  * 顶部：输入框（自动聚焦）
  * 下方：候选列表（实时过滤）
* 用户输入 key（如 `sigma`）

  * 候选列表同步过滤
* 用户按 `Enter`

  * 若存在“当前选中候选项”，则输出其 value（例如 `σ`）
  * 输出后面板自动隐藏（默认）
* 支持 `Esc` 关闭面板不输出

### 3.3 输出到光标处（关键要求）

* 回车后将字符输出到“当前应用的光标位置”，优先采用：

  1. **模拟键盘输入**（更像“真正输入”）
  2. 备选：**写入剪贴板 + 自动触发粘贴**（Ctrl+V / Cmd+V），并提供“保留原剪贴板”选项

> 注意：不同平台/不同应用的可行性不同。本产品需在 Windows 上优先实现“模拟输入”，并保留剪贴板方案作为兜底。

---

## 4. 映射体系设计

### 4.1 映射类型

* **系统默认映射（Built-in）**：随应用发布的只读字典

  * 例如：`sigma -> σ`、`Sigma -> Σ`、`alpha -> α`、`degree -> °` 等
* **用户映射（User-defined）**：用户可增删改

  * 支持中文 key：`西格玛 -> σ`
  * 支持 LaTeX 风格 key：`\sigma -> σ`、`sum -> Σ`（用户自己定义）
  * 支持多种别名指向同一个字符

### 4.2 冲突与优先级策略

系统默认映射不可更改，但用户可能希望在搜索/输出时“覆盖”：

* **查询合并策略**：候选列表同时展示 Built-in 与 User-defined
* **输出优先级**（建议默认）：

  * 若同名 key 同时存在：**用户映射优先**（因为用户无法修改内置，只能通过覆盖实现自定义）
  * 管理页面需显式提示“该 key 与系统默认冲突：将优先使用用户映射”
* 同时提供设置项：`Prefer built-in over user`（可选）

---

## 5. 功能需求（Functional Requirements）

### 5.1 快速输入面板

* FR-1：支持全局快捷键唤起/关闭面板
* FR-2：输入框自动聚焦，支持实时过滤
* FR-3：候选列表支持键盘导航（↑↓）、回车确认、Esc 取消
* FR-4：回车输出到当前光标处并自动隐藏
* FR-5：支持“无匹配时”的行为：

  * 默认：显示“无结果”，回车不输出
  * 可选：回车输出原始文本（可配置）

### 5.2 管理页面（映射管理）

* FR-6：列出用户映射列表（key/value/备注/创建时间/更新时间）
* FR-7：新增映射（key 必填、value 必填，可选备注/标签）
* FR-8：编辑映射（仅用户映射可编辑）
* FR-9：删除映射（仅用户映射可删除）
* FR-10：查看系统默认映射（只读）
* FR-11：导入/导出用户映射（JSON）
* FR-12：重置用户映射（清空用户映射，不影响系统默认）

### 5.3 设置

* FR-13：配置唤起快捷键（检测冲突；若冲突提示并要求重新设置）
* FR-14：配置输出方式

  * 模拟键盘输入 / 剪贴板粘贴（兜底）
  * 是否“恢复剪贴板原内容”
* FR-15：配置“候选排序”

  * 最近使用优先（MRU）
  * 精确匹配优先
* FR-16：开机自启动（可选）

### 5.4 最近使用与收藏（推荐）

* FR-17：记录最近 N 次输出的符号（仅本地）
* FR-18：支持收藏（pin）常用符号，在候选顶部固定显示

---

## 6. 数据设计（IndexedDB）

### 6.1 数据库

* DB Name：`unicode_quick_input`
* Version：1

### 6.2 Object Stores

1. `user_mappings`

* `key`（primary key）：string（如 `"sigma"` / `"西格玛"` / `"\\sigma"`）
* `value`：string（如 `"σ"`）
* `note`：string（可选）
* `tags`：string[]（可选）
* `created_at`：number（timestamp）
* `updated_at`：number（timestamp）

Index：

* `key_lower`（用于不区分大小写搜索）
* `updated_at`

2. `settings`

* `id`（primary key）：固定 `"global"`
* `hotkey`：string（默认 `"Alt+S"`）
* `output_mode`：`"inject"` | `"clipboard_paste"`
* `restore_clipboard`：boolean
* `prefer_user_mapping`：boolean（默认 true）
* `mru_enabled`：boolean
* `mru_size`：number

3. `mru`

* `id`（primary key）：auto-increment 或 `${timestamp}-${key}`
* `key`：string
* `value`：string
* `used_at`：number

> 系统默认映射不放入 IndexedDB（避免被“篡改”观感），建议打包为只读资源（JSON/二进制资源），在运行时加载到内存。

---

## 7. 搜索与匹配规则

* 精确匹配：`key === input`（大小写可配置，默认不敏感）
* 前缀匹配：`key startsWith input`
* 子串匹配：`key contains input`
* 排序建议：

  1. 精确匹配
  2. 前缀匹配
  3. 子串匹配
  4. 最近使用加权（若启用）
* 候选显示格式：

  * 主行：`value`（大号显示） + `key`
  * 次行：来源（Built-in / User） + note（可选）

---

## 8. 输出实现要求（Windows 优先）

### 8.1 模拟输入（推荐主路径）

* Windows：使用系统 API（如 SendInput）注入 Unicode 字符输入
* 要求：

  * 支持 BMP 与常见扩展字符（至少对希腊字母/数学符号可靠）
  * 在常见应用（Word、Edge、VS Code、Notepad）可用

### 8.2 剪贴板粘贴（兜底）

* 流程：保存当前剪贴板 → 写入目标字符 → 触发 Ctrl+V →（可选）恢复剪贴板
* 风险：

  * 可能被某些安全软件拦截
  * 粘贴快捷键在部分应用被重映射
* 需要提供设置开关与失败提示

### 8.3 失败提示

* 若输出失败（注入或粘贴失败），面板提示：

  * “插入失败，已复制到剪贴板”
  * 自动将字符复制到剪贴板作为兜底

---

## 9. UI/UX 规范（Fluent UI）

* 快速面板：

  * 无边框、圆角、阴影、置顶（Topmost）
  * 宽度约 420–560px，跟随屏幕中央或鼠标位置（可选）
  * 输入框用 Fluent UI `TextField`
  * 列表用 `List` / `DetailsList`（简化样式）
* 管理页面：

  * 左侧导航：Mappings / Built-in / Settings / Import-Export
  * 映射表格支持搜索、排序、编辑弹窗（Dialog）

---

## 10. 安全与隐私

* 所有数据仅本地 IndexedDB 存储，不上传网络。
* 若后续引入“在线字典/同步”，必须显式开关与隐私说明（不在本版本范围）。

---

## 11. 质量与验收标准（Acceptance Criteria）

### 11.1 核心验收

* AC-1：应用启动后默认托盘隐藏，不弹主窗口
* AC-2：`Alt+S` 可在任意应用前台时唤起输入面板
* AC-3：输入 `sigma` 可实时过滤到 `σ`（默认字典提供）
* AC-4：回车后 `σ` 能插入到当前光标处（Word/VS Code/浏览器输入框至少三种场景通过）
* AC-5：用户可在管理页面新增 `西格玛 -> σ`，且搜索 `西格玛` 可输出 `σ`
* AC-6：系统默认映射不可编辑/删除；用户映射可编辑/删除
* AC-7：同名 key 冲突时，默认优先使用用户映射，并有提示

### 11.2 可用性验收

* AC-8：面板唤起 < 150ms（体感“瞬开”）
* AC-9：常用词典规模（例如 2k–20k entries）下搜索无明显卡顿

---

## 12. 建议的系统默认映射（示例）

* 希腊字母：alpha/beta/gamma/.../omega（含大小写）
* 常见数学符号：degree、pm、times、div、neq、leq、geq、approx、infty、sum、prod、int 等
